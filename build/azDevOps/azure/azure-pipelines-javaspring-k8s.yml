#############################################################################################################################
# This is a generated file which includes some replacements.                                                                #
# It is still very much recommended to go through this and ensure all variables are correct for your business/domain        #
# All variables are defined in a global scope.                                                                              #
# All Terraform produced resource names are using a labels module ensuring a predictable naming convention                  #
# E.g.: variables for company, project, stage and domain will produce a name of `$company-$project-$stage-$domain`          #
# NB: Some resources e.g. blob storage only allow for alpha numeric characters so the name is adjusted accordingly          #
#  ==> `$company$project$stage$domain`                                                                                      #
#############################################################################################################################
name: "$(Build.SourceBranchName)-init"

pr:
  - master

trigger:
  branches:
    include:
      - 'master'
  paths:
    include:
      - '*'

resources:
  repositories:
    - repository: templates
      type: github
      name: amido/stacks-pipeline-templates
      ref: refs/tags/v2.0.1
      # EXCHANGE THIS FOR YOUR OWN ENDPOINT CONNECTION TO GITHUB
      # REPOSITORY IS PUBLIC
      endpoint: amidostacks

  containers:
    # Container for Java Build and Testing
    - container: azul_java
      image: azul/zulu-openjdk-debian:11
    # Container for inlining Jacoco assets as Azure DevOps strips them
    # https://github.com/microsoft/azure-pipelines-tasks/issues/3027
    - container: node
      image: amidostacks/node-14:0.0.1
    # Container for Sonar Scanner
    - container: sonar_scanner
      image: amidostacks/ci-sonarscanner:0.0.2
    # Container for Kubernetes Deployment
    - container: k8s_deploy
      image: amidostacks/ci-k8s:0.0.12
    # Container for Terraform deployments
    - container: terraform_custom
      image: amidostacks/ci-tf:0.0.8

variables:
  company: amido
  project: stacks
  domain: java-api
  component: api
  role: backend
  #
  # SelfConfig
  # If you haven't specified source_repo at cli runtime please ensure you replace it here
  # It is case sensitive for TFS based repos
  self_repo: stacks-java
  self_remote_repo: "amido/$(self_repo)"
  self_repo_src: java
  self_post_deploy_test_src: "api-tests"
  self_repo_dir: "$(Agent.BuildDirectory)/s/$(self_repo)"
  self_project_dir: "$(self_repo_dir)/$(self_repo_src)"
  self_functional_testproject_dir: "$(self_repo_dir)/$(self_post_deploy_test_src)"
  self_repo_tf_src: deploy/azure/app/kube
  self_repo_tf_dir: "$(self_repo_dir)/$(self_repo_tf_src)"
  self_generic_name: $(project)-$(domain)
  self_pipeline_repo: "$(Agent.BuildDirectory)/s/stacks-pipeline-templates"
  self_pipeline_scripts_dir: "$(self_pipeline_repo)/scripts"
  # TF STATE CONFIG
  tf_state_rg: "Stacks-Ancillary-Resources"
  tf_state_storage: "amidostackstfstate"
  tf_state_container: "tfstate"
  # Stacks operates Terraform states based on workspaces **IT IS VERY IMPORTANT** that you ensure a unique name for each application definition
  # Furthermore **IT IS VERY IMPORTANT** that you change the name of a workspace for each deployment stage
  # there are some best practices around this if you are going for feature based environments
  # - we suggest you create a runtime variable that is dynamically set based on a branch currently running
  # **`terraform_state_workspace: `**
  # avoid running anything past dev that is not on master
  # sample value: company-webapp
  tf_state_key: "stacks-api-java"
  # Environment
  # Name of the resource group for DNS
  dns_zone_resource_group: "Stacks-Ancillary-Resources"
  # Versioning
  version_major: 0
  version_minor: 0
  version_revision: "$[counter(join(variables['version_major'], join('-', variables['version_minor'])), 0)]"
  # PR / Branch vars
  source_branch_ref: "$[coalesce(variables['System.PullRequest.SourceBranch'], variables['Build.SourceBranch'])]"
  target_branch_ref: "$[coalesce(variables['System.PullRequest.TargetBranch'], '')]"
  pullrequest_number: "$[coalesce(variables['System.PullRequest.PullRequestNumber'], variables['System.PullRequest.PullRequestId'], '')]"
  # Docker Config
  docker_dockerfile_path: "."
  docker_image_name: "$(self_generic_name)"
  docker_image_tag: "${{ variables.version_major }}.${{ variables.version_minor }}.$(version_revision)-$(Build.SourceBranchName)"
  docker_container_registry_name_nonprod: amidostacksnonprodeuwcore
  docker_java_image: "azul_java"
  k8s_docker_registry_nonprod: "${{ variables.docker_container_registry_name_nonprod }}.azurecr.io"
  docker_container_registry_name_prod: amidostacksprodeuwcore
  k8s_docker_registry_prod: "${{ variables.docker_container_registry_name_prod }}.azurecr.io"
  # BUILD ARTIFACTS across stages
  build_artifact_deploy_path: "${{ variables.self_repo_dir }}/deploy/k8s/app"
  build_artifact_deploy_name: "${{ variables.self_generic_name }}"
  # DEFAULT IMAGE RUNNER
  pool_vm_image: ubuntu-20.04
  # Infra
  region: "westeurope"
  base_domain_nonprod: nonprod.amidostacks.com
  base_domain_internal_nonprod: nonprod.amidostacks.internal
  base_domain_prod: prod.amidostacks.com
  base_domain_internal_prod: prod.amidostacks.internal
  # Maven
  maven_cache_directory: "./.m2"
  maven_surefire_reports_dir: "target/surefire-reports"
  maven_allowed_test_tags: "Unit | Component | Integration"
  maven_allowed_post_deploy_test_tags: "@Functional or @Smoke or @Performance"
  maven_ignored_post_deploy_test_tags: "@Ignore"
  maven_post_deploy_html_report_directory: "target/site/serenity"
  maven_post_deploy_failsafe_reports_directory: "target/failsafe-reports"
  # Vulnerability Scan
  vulnerability_scan: true
  vulnerability_scan_report: "target/dependency-check-report.html"
  vulnerability_scan_fail_build_on_detection: false
  # Yamllint
  yamllint_config_file: "${{ variables.self_repo_dir }}/yamllint.conf"
  yamllint_scan_directory: "."
  # Functional Tests
  functional_test: true
  functional_test_path: "${{ variables.self_functional_testproject_dir }}"
  functional_test_artefact_path: "${{ variables.self_repo_dir }}/${{ variables.self_post_deploy_test_src }}"
  functional_test_artefact_name: "post-deploy-test-artefact"
  functional_test_artefact_download_location: "$(Pipeline.Workspace)/${{ variables.functional_test_artefact_name }}"
  # Build Task Naming
  java_project_type: "Java App"
  functional_test_project_type: "Functional API Tests"

stages:
  - stage: Build
    variables:
      # You can find notes in the READMEs around which values to use for each ENV variable group
      - group: amido-stacks-infra-credentials-nonprod
      - group: stacks-credentials-nonprod-kv
      - group: amido-stacks-java-api
    jobs:
      - job: ApiBuild
        pool:
          vmImage: $(pool_vm_image)
        steps:
          - checkout: self

          - checkout: templates

          # Updates the build number in Azure DevOps (requires refresh in the UI to see)
          - bash: |
              echo '##vso[Build.UpdateBuildNumber]${{ variables.docker_image_tag }}'
            displayName: 'Update: Build Number'

          # Validates all YAML files in the repo to check they adhere to standards
          - template: templates/steps/build/test-validate-yaml.yml
            parameters:
              pipeline_scripts_directory: "${{ variables.self_pipeline_scripts_dir }}"
              container: "k8s_deploy"
              yamllint_config_file: "${{ variables.yamllint_config_file }}"
              yamllint_scan_directory: "${{ variables.yamllint_scan_directory }}"

          # Runs a terraform fomatting check and a validation check
          - template: templates/steps/build/test-validate-terraform.yml
            parameters:
              pipeline_scripts_directory: "${{ variables.self_pipeline_scripts_dir }}"
              terraform_container: "terraform_custom"
              terraform_directory: "${{ variables.self_repo_tf_dir }}"

          # Builds the Java app and runs tests
          - template: templates/steps/build/build-java.yml
            parameters:
              repo_root_dir: "${{ variables.self_repo_dir }}"
              project_root_dir: "${{ variables.self_project_dir }}"
              pipeline_scripts_directory: "${{ variables.self_pipeline_scripts_dir }}"
              # Maven
              maven_cache_directory: "${{ variables.maven_cache_directory }}"
              maven_surefire_reports_dir: "${{ variables.maven_surefire_reports_dir }}"
              maven_allowed_test_tags: "${{ variables.maven_allowed_test_tags}}"
              # Docker
              docker_build_container: "${{ variables.docker_java_image }}"
              # Vulnerability Scanning
              vulnerability_scan: "${{ variables.vulnerability_scan }}"
              vulnerability_scan_fail_build_on_detection: "${{ variables.vulnerability_scan_fail_build_on_detection }}"
              project_type: "${{ variables.java_project_type }}"

          # Builds the Java API Tests
          - template: templates/steps/build/build-api-tests.yml
            parameters:
              repo_root_dir: "${{ variables.self_repo_dir }}"
              functional_test_project_root_dir: "${{ variables.self_functional_testproject_dir }}"
              functional_test_artefact_path: "${{ variables.functional_test_artefact_path }}"
              pipeline_scripts_directory: "${{ variables.self_pipeline_scripts_dir }}"
              # Maven
              maven_untagged_test_check: true
              maven_cache_directory: "${{ variables.maven_cache_directory }}"
              maven_allowed_post_deploy_test_tags: "${{ variables.maven_allowed_post_deploy_test_tags }}"
              maven_ignored_post_deploy_test_tags: "${{ variables.maven_ignored_post_deploy_test_tags }}"
              maven_post_deploy_html_report_directory: "${{ variables.maven_post_deploy_html_report_directory }}"
              maven_post_deploy_failsafe_reports_directory: "${{ variables.maven_post_deploy_failsafe_reports_directory }}"
              # Docker
              docker_build_container: "${{ variables.docker_java_image }}"
              # Vulnerability Scan
              vulnerability_scan: "${{ variables.vulnerability_scan }}"
              vulnerability_scan_fail_build_on_detection: "${{ variables.vulnerability_scan_fail_build_on_detection }}"
              project_type: "${{ variables.functional_test_project_type }}"

          # Performs stati code analysis, such as Sonar Cloud
          - template: templates/steps/build/test-static-code-analysis.yml
            parameters:
              project_root_dir: "${{ variables.self_project_dir }}"
              pipeline_scripts_directory: "${{ variables.self_pipeline_scripts_dir}}"
              # PR / Branch vars
              source_branch_ref: "$(source_branch_ref)"
              target_branch_ref: "$(target_branch_ref)"
              pullrequest_number: "$(pullrequest_number)"
              # Sonar
              sonar_enable: true
              sonar_container: "sonar_scanner"
              sonar_host_url: "https://sonarcloud.io"
              sonar_project_name: "$(SONAR_PROJECT_NAME)"
              sonar_project_key: "$(SONAR_PROJECT_KEY)"
              sonar_token: "$(SONAR_TOKEN)"
              sonar_organisation: "$(SONAR_ORGANIZATION)"
              # Probably `GitHub` or `vsts`
              sonar_pullrequest_provider: "GitHub"
              sonar_remote_repo: "${{ variables.self_remote_repo }}"
              sonar_command: "sonar-scanner"
              # Docker
              docker_image_tag: "${{ variables.docker_image_tag }}"

          # Builds the Docker image and pushes it to an ACR
          - template: templates/steps/build/build-docker-image.yml
            parameters:
              project_root_dir: "${{ variables.self_project_dir }}"
              pipeline_scripts_directory: "${{ variables.self_pipeline_scripts_dir }}"
              docker_k8s_container: "k8s_deploy"
              docker_build_additional_args: "."
              docker_image_name: "${{ variables.docker_image_name }}"
              docker_image_tag: "${{ variables.docker_image_tag }}"
              docker_container_registry_name: "${{ variables.docker_container_registry_name_nonprod }}"
              # Azure
              azure_client_id: "$(azure-client-id)"
              azure_client_secret: "$(azure-client-secret)"
              azure_tenant_id: "$(azure-tenant-id)"
              azure_subscription_id: "$(azure-subscription-id)"

          # Post build tasks, such as Test and Coverage upload, and publishing artefacts
          - template: templates/steps/build/post-build-tasks.yml
            parameters:
              project_root_dir: "${{ variables.self_project_dir }}"
              functional_test_project_root_dir: "${{ variables.self_functional_testproject_dir }}"
              # Build Output File
              # files to be persisted across stages
              build_file: true
              build_file_path: "${{ variables.build_artifact_deploy_path }}"
              build_file_artefact_name: "${{ variables.build_artifact_deploy_name }}"
              # Functional tests
              functional_test: ${{ variables.functional_test }}
              functional_test_artefact_name: "${{ variables.functional_test_artefact_name }}"
              functional_test_artefact_path: "${{ variables.functional_test_artefact_path }}"
              vulnerability_scan: "${{ variables.vulnerability_scan }}"
              vulnerability_scan_report: "${{ variables.vulnerability_scan_report }}"
              java_project_type: "${{ variables.java_project_type }}"
              functional_test_project_type: "${{ variables.functional_test_project_type }}"

  - stage: Dev
    dependsOn: Build
    condition: and(succeeded(), ne(variables['Build.SourceBranch'], 'refs/heads/master'))
    variables:
      - group: amido-stacks-infra-credentials-nonprod
      - group: stacks-credentials-nonprod-kv
      - group: amido-stacks-java-api
      - name: dns_name
        value: "$(Environment.ShortName)-java-api"
      - name: core_resource_group
        value: "amido-stacks-nonprod-euw-core"
      - name: Environment.ShortName
        value: dev
    jobs:
      - deployment: AppInfraDev
        container: terraform_custom
        pool:
          vmImage: $(pool_vm_image)
        environment: ${{ variables.domain }}-dev
        variables:
          - name: attributes
            value: "[]"
          - name: tags
            value: "{}"
          - name: resource_group_location
            value: "$(region)"
          - name: app_gateway_frontend_ip_name
            value: "amido-stacks-nonprod-euw-core"
          - name: create_cosmosdb
            value: true
          - name: create_cache
            value: false
          - name: create_dns_record
            value: true
          - name: create_cdn_endpoint
            value: false
          - name: cosmosdb_sql_container
            value: "Menu"
          - name: cosmosdb_sql_container_partition_key
            value: "/id"
          - name: cosmosdb_kind
            value: "GlobalDocumentDB"
          - name: cosmosdb_offer_type
            value: "Standard"
          - name: app_insights_name
            value: "amido-stacks-nonprod-euw-core"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - checkout: templates

                - template: templates/steps/deploy/deploy-infra.yml
                  parameters:
                    pipeline_scripts_directory: "${{ variables.self_pipeline_scripts_dir }}"
                    docker_terraform_container: "terraform_custom"
                    # Azure Credenitals (For Deploying)
                    azure_client_id: "$(azure-client-id)"
                    azure_client_secret: "$(azure-client-secret)"
                    azure_tenant_id: "$(azure-tenant-id)"
                    azure_subscription_id: "$(azure-subscription-id)"
                    # Terraform
                    terraform_directory: '$(self_repo_tf_dir)'
                    # Backend Azure State Storage Credentials
                    # Change these if your state storage is in a different
                    # location to your deployment
                    terraform_backend_azure_client_id: "$(azure-client-id)"
                    terraform_backend_azure_client_secret: "$(azure-client-secret)"
                    terraform_backend_azure_tenant_id: "$(azure-tenant-id)"
                    terraform_backend_azure_subscription_id: "$(azure-subscription-id)"
                    terraform_state_rg: ${{ variables.tf_state_rg }}
                    terraform_state_storage: ${{ variables.tf_state_storage }}
                    terraform_state_container: ${{ variables.tf_state_container }}
                    terraform_state_key: ${{ variables.tf_state_key }}
                    terraform_state_workspace: $(Environment.ShortName)
                    terraform_extra_properties: {
                      TF_VAR_name_company: "${{ variables.company }}",
                      TF_VAR_name_project: "${{ variables.project }}",
                      TF_VAR_name_domain: "${{ variables.domain }}",
                      TF_VAR_name_component: "${{ variables.component }}",
                      TF_VAR_name_role: "${{ variables.role }}",
                      TF_VAR_name_environment: "$(Environment.ShortName)",
                      TF_VAR_attributes: "${{ variables.attributes }}",
                      TF_VAR_tags: "${{ variables.tags }}",
                      TF_VAR_resource_group_location: "${{ variables.resource_group_location }}",
                      TF_VAR_app_gateway_frontend_ip_name: "${{ variables.app_gateway_frontend_ip_name }}",
                      TF_VAR_dns_record: "${{ variables.dns_name }}",
                      TF_VAR_dns_zone_name: "${{ variables.base_domain_nonprod }}",
                      TF_VAR_dns_zone_resource_group: "${{ variables.dns_zone_resource_group }}",
                      TF_VAR_core_resource_group: "${{ variables.core_resource_group }}",
                      TF_VAR_internal_dns_zone_name: "${{ variables.base_domain_internal_nonprod }}",
                      TF_VAR_create_cosmosdb: "${{ variables.create_cosmosdb }}",
                      TF_VAR_create_cache: "${{ variables.create_cache }}",
                      TF_VAR_create_dns_record: "${{ variables.create_dns_record }}",
                      TF_VAR_create_cdn_endpoint: "${{ variables.create_cdn_endpoint }}",
                      TF_VAR_cosmosdb_sql_container: "${{ variables.cosmosdb_sql_container }}",
                      TF_VAR_cosmosdb_sql_container_partition_key: "${{ variables.cosmosdb_sql_container_partition_key }}",
                      TF_VAR_cosmosdb_kind: "${{ variables.cosmosdb_kind }}",
                      TF_VAR_cosmosdb_offer_type: "${{ variables.cosmosdb_offer_type }}",
                      TF_VAR_app_insights_name: "${{ variables.app_insights_name }}",
                    }
                    terraform_output_commands: |
                      raw_tf=$(terraform output -json | jq -r 'keys[] as $k | "##vso[task.setvariable variable=\($k);isOutput=true]\(.[$k] | .value)"')
                      readarray -t outputs <<< "$raw_tf"
                      for i in "${outputs[@]}"; do echo "$i"; done
                    # changing this would require changing the App deploy stage to make use of this
                    terraform_output_artefact_name: 'tfoutputs'

      - deployment: DeployDev
        dependsOn: AppInfraDev
        container: k8s_deploy
        pool:
          vmImage: $(pool_vm_image)
        environment: ${{ variables.domain }}-dev
        variables:
          - name: cosmosdb_database_name
            value: "$[ dependencies.AppInfraDev.outputs['AppInfraDev.tfoutputs.cosmosdb_database_name'] ]"
          - name: cosmosdb_endpoint
            value: "$[ dependencies.AppInfraDev.outputs['AppInfraDev.tfoutputs.cosmosdb_endpoint'] ]"
          - name: cosmosdb_primary_master_key
            value: "$[ dependencies.AppInfraDev.outputs['AppInfraDev.tfoutputs.cosmosdb_primary_master_key'] ]"
          - name: app_insights_instrumentation_key
            value: "$[ dependencies.AppInfraDev.outputs['AppInfraDev.tfoutputs.app_insights_instrumentation_key'] ]"
          - name: resource_def_name
            value: "stacks-java-api"
          - name: namespace
            value: "$(Environment.ShortName)-java-api"
          - name: k8s_app_path
            value: "/api/menu"
          - name: dns_pointer
            value: "${{ variables.dns_name }}.${{ variables.base_domain_nonprod }}"
          - name: functional_test_base_url
            value: "https://${{ variables.dns_pointer }}${{ variables.k8s_app_path }}"
          - name: aks_cluster_resourcegroup
            value: "${{ variables.core_resource_group }}"
          - name: aks_cluster_name
            value: "amido-stacks-nonprod-euw-core"
          - name: app_name
            value: "java-api"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - checkout: templates

                - template: templates/steps/deploy/deploy-app.yml
                  parameters:
                    pipeline_scripts_directory: $(self_pipeline_scripts_dir)
                    shared_replacements: {
                      namespace: "${{ variables.namespace }}",
                      role: "${{ variables.role }}",
                      company: "${{ variables.company }}",
                      project: "${{ variables.project }}",
                      domain: "${{ variables.domain }}",
                      component: "${{ variables.component }}",
                      app_name: "${{ variables.app_name }}",
                      resource_def_name: "${{ variables.resource_def_name }}",
                      version: "${{ variables.docker_image_tag }}",
                      environment: $(Environment.ShortName),
                    }
                    # Used for doing template substitutions and deployments
                    template_input: [
                      {
                        base: "${{ variables.self_repo_dir }}/deploy/k8s/app/base_api-deploy.yml",
                        out: "${{ variables.self_repo_dir }}/deploy/k8s/app/api-deploy.yml",
                        displayName: "App Deployment",
                        replacements: {
                          dns_pointer: "${{ variables.dns_pointer }}",
                          tls_domain: "${{ variables.base_domain_nonprod }}",
                          k8s_app_path: "${{ variables.k8s_app_path }}",
                          log_level: "Debug",
                          k8s_image: '${{ variables.k8s_docker_registry_nonprod }}/${{ variables.docker_image_name }}:${{ variables.docker_image_tag }}',
                          # Unused currently
                          aadpodidentitybinding: stacks-webapp-identity,
                          app_insights_key: "$(app_insights_instrumentation_key)",
                          cosmosdb_key: "$(cosmosdb_primary_master_key)",
                          cosmosdb_endpoint: "$(cosmosdb_endpoint)",
                          cosmosdb_name: "$(cosmosdb_database_name)",
                        },
                        additional_args: "-no-empty",
                      },
                    ]
                    azure_client_id: "$(azure-client-id)"
                    azure_client_secret: "$(azure-client-secret)"
                    azure_tenant_id: "$(azure-tenant-id)"
                    azure_subscription_id: "$(azure-subscription-id)"
                    aks_cluster_resourcegroup: "${{ variables.aks_cluster_resourcegroup }}"
                    aks_cluster_name: "${{ variables.aks_cluster_name }}"
                    # Used to do a `kubectl rollout status`
                    deployments: [
                      {
                        name: "deploy/${{ variables.resource_def_name }}",
                        namespace: "${{ variables.namespace }}",
                        timeout: "120s",
                      },
                    ]

                - template: templates/steps/deploy/deploy-post-deploy-tests.yml
                  parameters:
                    environment: "$(Environment.ShortName)"
                    pipeline_scripts_directory: "${{ variables.self_pipeline_scripts_dir }}"
                    functional_test: ${{ variables.functional_test }}
                    functional_test_artefact_name: "${{ variables.functional_test_artefact_name }}"
                    functional_test_artefact_download_location: "${{ variables.functional_test_artefact_download_location }}"
                    functional_test_base_url: "${{ variables.functional_test_base_url }}"
                    maven_cache_directory: "${{ variables.maven_cache_directory }}"
                    maven_ignored_post_deploy_test_tags: "${{ variables.maven_ignored_post_deploy_test_tags }}"
                    maven_post_deploy_html_report_directory: "${{ variables.maven_post_deploy_html_report_directory }}"
                    docker_java_container: "${{ variables.docker_java_image }}"
                    auth0_credentials:
                      {
                        CLIENT_ID: $(AUTH0_CLIENT_ID),
                        CLIENT_SECRET: $(AUTH0_CLIENT_SECRET),
                        AUDIENCE: $(AUTH0_AUDIENCE),
                        GRANT_TYPE: client_credentials,
                        OAUTH_TOKEN_URL: $(AUTH0_TOKEN_URL),
                        BASE_URL: "${{ variables.dns_pointer }}",
                      }

  - stage: Prod
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    variables:
      - group: amido-stacks-infra-credentials-prod
      - group: stacks-credentials-prod-kv
      - group: amido-stacks-java-api
      - name: dns_name
        value: "$(Environment.ShortName)-java-api"
      - name: core_resource_group
        value: "amido-stacks-prod-euw-core"
      - name: Environment.ShortName
        value: prod
    jobs:
      - deployment: AppInfraProd
        container: terraform_custom
        pool:
          vmImage: $(pool_vm_image)
        environment: ${{ variables.domain }}-prod
        variables:
          - name: app_insights_name
            value: "amido-stacks-prod-euw-core"
          - name: app_gateway_frontend_ip_name
            value: "amido-stacks-prod-euw-core"
          - name: attributes
            value: "[]"
          - name: tags
            value: "{}"
          - name: resource_group_location
            value: "$(region)"
          - name: create_cosmosdb
            value: true
          - name: create_cache
            value: false
          - name: create_dns_record
            value: true
          - name: create_cdn_endpoint
            value: false
          - name: cosmosdb_sql_container
            value: "Menu"
          - name: cosmosdb_sql_container_partition_key
            value: "/id"
          - name: cosmosdb_kind
            value: "GlobalDocumentDB"
          - name: cosmosdb_offer_type
            value: "Standard"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - checkout: templates

                - template: templates/steps/deploy/deploy-infra.yml
                  parameters:
                    pipeline_scripts_directory: "${{ variables.self_pipeline_scripts_dir }}"
                    docker_terraform_container: "terraform_custom"
                    # Azure Credenitals (For Deploying)
                    azure_client_id: "$(prod-azure-client-id)"
                    azure_client_secret: "$(prod-azure-client-secret)"
                    azure_tenant_id: "$(prod-azure-tenant-id)"
                    azure_subscription_id: "$(prod-azure-subscription-id)"
                    # Terraform
                    terraform_directory: '$(self_repo_tf_dir)'
                    # Backend Azure State Storage Credentials
                    # Change these if your state storage is in a different
                    # location to your deployment
                    terraform_backend_azure_client_id: "$(prod-azure-client-id)"
                    terraform_backend_azure_client_secret: "$(prod-azure-client-secret)"
                    terraform_backend_azure_tenant_id: "$(prod-azure-tenant-id)"
                    terraform_backend_azure_subscription_id: "$(prod-azure-subscription-id)"
                    terraform_state_rg: ${{ variables.tf_state_rg }}
                    terraform_state_storage: ${{ variables.tf_state_storage }}
                    terraform_state_container: ${{ variables.tf_state_container }}
                    terraform_state_key: ${{ variables.tf_state_key }}
                    terraform_state_workspace: $(Environment.ShortName)
                    terraform_extra_properties: {
                      TF_VAR_name_company: "${{ variables.company }}",
                      TF_VAR_name_project: "${{ variables.project }}",
                      TF_VAR_name_domain: "${{ variables.domain }}",
                      TF_VAR_name_component: "${{ variables.component }}",
                      TF_VAR_name_role: "${{ variables.role }}",
                      TF_VAR_name_environment: "$(Environment.ShortName)",
                      TF_VAR_attributes: "${{ variables.attributes }}",
                      TF_VAR_tags: "${{ variables.tags }}",
                      TF_VAR_resource_group_location: "${{ variables.resource_group_location }}",
                      TF_VAR_app_gateway_frontend_ip_name: "${{ variables.app_gateway_frontend_ip_name }}",
                      TF_VAR_dns_record: "${{ variables.dns_name }}",
                      TF_VAR_dns_zone_name: "${{ variables.base_domain_prod }}",
                      TF_VAR_dns_zone_resource_group: "${{ variables.dns_zone_resource_group }}",
                      TF_VAR_core_resource_group: "${{ variables.core_resource_group }}",
                      TF_VAR_internal_dns_zone_name: "${{ variables.base_domain_internal_prod }}",
                      TF_VAR_create_cosmosdb: "${{ variables.create_cosmosdb }}",
                      TF_VAR_create_cache: "${{ variables.create_cache }}",
                      TF_VAR_create_dns_record: "${{ variables.create_dns_record }}",
                      TF_VAR_create_cdn_endpoint: "${{ variables.create_cdn_endpoint }}",
                      TF_VAR_cosmosdb_sql_container: "${{ variables.cosmosdb_sql_container }}",
                      TF_VAR_cosmosdb_sql_container_partition_key: "${{ variables.cosmosdb_sql_container_partition_key }}",
                      TF_VAR_cosmosdb_kind: "${{ variables.cosmosdb_kind }}",
                      TF_VAR_cosmosdb_offer_type: "${{ variables.cosmosdb_offer_type }}",
                      TF_VAR_app_insights_name: "${{ variables.app_insights_name }}",
                    }
                    terraform_output_commands: |
                      raw_tf=$(terraform output -json | jq -r 'keys[] as $k | "##vso[task.setvariable variable=\($k);isOutput=true]\(.[$k] | .value)"')
                      readarray -t outputs <<< "$raw_tf"
                      for i in "${outputs[@]}"; do echo "$i"; done
                    # changing this would require changing the App deploy stage to make use of this
                    terraform_output_artefact_name: 'tfoutputs'

      - deployment: PromotionProd
        dependsOn: AppInfraProd
        container: k8s_deploy
        pool:
          vmImage: $(pool_vm_image)
        environment: ${{ variables.domain }}-prod
        variables:
          - group: amido-stacks-infra-credentials-nonprod
          - group: amido-stacks-infra-credentials-prod
          - group: stacks-credentials-prod-kv
          - group: stacks-credentials-nonprod-kv
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - checkout: templates

                - task: Bash@3
                  inputs:
                    filePath: "$(self_pipeline_scripts_dir)/util-azure-promote-image.bash"
                    arguments: >
                      -a "$(docker_image_name):$(docker_image_tag)"
                      -b "$(k8s_docker_registry_nonprod)"
                      -c "$(azure-subscription-id)"
                      -d "$(azure-client-id)"
                      -e "$(azure-client-secret)"
                      -f "$(azure-tenant-id)"
                      -g "$(k8s_docker_registry_prod)"
                      -h "$(prod-azure-subscription-id)"
                      -i "$(prod-azure-client-id)"
                      -j "$(prod-azure-client-secret)"
                      -k "$(prod-azure-tenant-id)"
                      -Z "false"
                  displayName: Promote Docker Image to Production ACR

      - deployment: DeployProd
        dependsOn:
          - AppInfraProd
          - PromotionProd
        container: k8s_deploy
        pool:
          vmImage: $(pool_vm_image)
        environment: ${{ variables.domain }}-prod
        variables:
          - name: cosmosdb_database_name
            value: "$[ dependencies.AppInfraProd.outputs['AppInfraProd.tfoutputs.cosmosdb_database_name'] ]"
          - name: cosmosdb_endpoint
            value: "$[ dependencies.AppInfraProd.outputs['AppInfraProd.tfoutputs.cosmosdb_endpoint'] ]"
          - name: cosmosdb_primary_master_key
            value: "$[ dependencies.AppInfraProd.outputs['AppInfraProd.tfoutputs.cosmosdb_primary_master_key'] ]"
          - name: app_insights_instrumentation_key
            value: "$[ dependencies.AppInfraProd.outputs['AppInfraProd.tfoutputs.app_insights_instrumentation_key'] ]"
          - name: resource_def_name
            value: "stacks-java-api"
          - name: namespace
            value: "$(Environment.ShortName)-java-api"
          - name: k8s_app_path
            value: "/api/menu"
          - name: dns_pointer
            value: "${{ variables.dns_name }}.${{ variables.base_domain_prod }}"
          - name: functional_test_base_url
            value: "https://${{ variables.dns_pointer }}/${{ variables.k8s_app_path }}"
          - name: aks_cluster_resourcegroup
            value: "${{ variables.core_resource_group }}"
          - name: aks_cluster_name
            value: "amido-stacks-prod-euw-core"
          - name: app_name
            value: "java-api"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - checkout: templates

                - template: templates/steps/deploy/deploy-app.yml
                  parameters:
                    pipeline_scripts_directory: $(self_pipeline_scripts_dir)
                    shared_replacements: {
                      namespace: "${{ variables.namespace }}",
                      role: "${{ variables.role }}",
                      company: "${{ variables.company }}",
                      project: "${{ variables.project }}",
                      domain: "${{ variables.domain }}",
                      component: "${{ variables.component }}",
                      app_name: "${{ variables.app_name }}",
                      resource_def_name: "${{ variables.resource_def_name }}",
                      version: "${{ variables.docker_image_tag }}",
                      environment: $(Environment.ShortName),
                    }
                    # Used for doing template substitutions and deployments
                    template_input: [
                      {
                        base: "${{ variables.self_repo_dir }}/deploy/k8s/app/base_api-deploy.yml",
                        out: "${{ variables.self_repo_dir }}/deploy/k8s/app/api-deploy.yml",
                        displayName: "App Deployment",
                        replacements: {
                          dns_pointer: "${{ variables.dns_pointer }}",
                          tls_domain: "${{ variables.base_domain_prod }}",
                          k8s_app_path: "${{ variables.k8s_app_path }}",
                          log_level: "Debug",
                          k8s_image: '${{ variables.k8s_docker_registry_prod }}/${{ variables.docker_image_name }}:${{ variables.docker_image_tag }}',
                          aadpodidentitybinding: stacks-webapp-identity,
                          app_insights_key: "$(app_insights_instrumentation_key)",
                          cosmosdb_key: "$(cosmosdb_primary_master_key)",
                          cosmosdb_endpoint: "$(cosmosdb_endpoint)",
                          cosmosdb_name: "$(cosmosdb_database_name)",
                        },
                        additional_args: "-no-empty",
                      },
                    ]
                    azure_client_id: "$(prod-azure-client-id)"
                    azure_client_secret: "$(prod-azure-client-secret)"
                    azure_tenant_id: "$(prod-azure-tenant-id)"
                    azure_subscription_id: "$(prod-azure-subscription-id)"
                    aks_cluster_resourcegroup: "${{ variables.aks_cluster_resourcegroup }}"
                    aks_cluster_name: "${{ variables.aks_cluster_name }}"
                    # Used to do a `kubectl rollout status`
                    deployments: [
                      {
                        name: "deploy/${{ variables.resource_def_name }}",
                        namespace: "${{ variables.namespace }}",
                        timeout: "120s",
                      },
                    ]

                - template: templates/steps/deploy/deploy-post-deploy-tests.yml
                  parameters:
                    environment: "$(Environment.ShortName)"
                    pipeline_scripts_directory: "${{ variables.self_pipeline_scripts_dir }}"
                    functional_test: ${{ variables.functional_test }}
                    functional_test_artefact_name: "${{ variables.functional_test_artefact_name }}"
                    functional_test_artefact_download_location: "${{ variables.functional_test_artefact_download_location }}"
                    functional_test_base_url: "${{ variables.functional_test_base_url }}"
                    maven_cache_directory: "${{ variables.maven_cache_directory }}"
                    maven_ignored_post_deploy_test_tags: "${{ variables.maven_ignored_post_deploy_test_tags }}"
                    maven_post_deploy_html_report_directory: "${{ variables.maven_post_deploy_html_report_directory }}"
                    docker_java_container: "${{ variables.docker_java_image }}"
                    auth0_credentials:
                      {
                        CLIENT_ID: $(AUTH0_CLIENT_ID),
                        CLIENT_SECRET: $(AUTH0_CLIENT_SECRET),
                        AUDIENCE: $(AUTH0_AUDIENCE),
                        GRANT_TYPE: client_credentials,
                        OAUTH_TOKEN_URL: $(AUTH0_TOKEN_URL),
                        BASE_URL: "${{ variables.dns_pointer }}",
                      }
